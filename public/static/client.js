"use strict";(()=>{var D=Object.defineProperty;var w=(o,l)=>{for(var r in l)D(o,r,{get:l[r],enumerable:!0})};var v={};w(v,{checkAuth:()=>b,initLogin:()=>M,initLogout:()=>E,initRegister:()=>x,logout:()=>S});function M(o="login-form",l="auth-message"){let r=document.getElementById(o);r&&r.addEventListener("submit",async s=>{s.preventDefault();let e=document.getElementById(l),t=r.querySelector('button[type="submit"]'),p=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Iniciando sesi\xF3n...',e&&(e.style.display="none");let i=new FormData(r);try{let f=await(await fetch("/api/login",{method:"POST",body:i})).json();if(f.success)e&&(e.className="auth-message success",e.textContent="\xA1Bienvenido! Redirigiendo...",e.style.display="block"),setTimeout(()=>{window.location.href="/mi-aprendizaje"},1e3);else throw new Error(f.error||"Error al iniciar sesi\xF3n")}catch(u){e&&(e.className="auth-message error",e.textContent=u.message,e.style.display="block"),t.disabled=!1,t.innerHTML=p}})}function x(o="register-form",l="auth-message"){let r=document.getElementById(o);r&&r.addEventListener("submit",async s=>{s.preventDefault();let e=document.getElementById(l),t=r.querySelector('button[type="submit"]'),p=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creando cuenta...',e&&(e.style.display="none");let i=new FormData(r);try{let f=await(await fetch("/api/register",{method:"POST",body:i})).json();if(f.success)e&&(e.className="auth-message success",e.textContent="\xA1Cuenta creada! Redirigiendo...",e.style.display="block"),setTimeout(()=>{window.location.href="/mi-aprendizaje"},1e3);else throw new Error(f.error||"Error al crear cuenta")}catch(u){e&&(e.className="auth-message error",e.textContent=u.message,e.style.display="block"),t.disabled=!1,t.innerHTML=p}})}async function S(){if(confirm("\xBFEst\xE1s seguro que deseas cerrar sesi\xF3n?"))try{(await fetch("/api/logout",{method:"POST"})).ok&&(window.location.href="/")}catch(o){console.error("Error al cerrar sesi\xF3n:",o),alert("Error al cerrar sesi\xF3n. Por favor, intenta de nuevo.")}}function E(){let o=document.getElementById("logoutBtn");o&&o.addEventListener("click",S)}async function b(){function o(s){var e=document.getElementById(s);e&&e.remove()}function l(s,e){var t=document.getElementById(s);t&&(t.style.display=e||"inline-flex")}try{let e=await(await fetch("/api/me")).json();if(e.success&&e.user)if(o("login-link"),o("start-link"),l("dashboard-link"),e.user.role==="admin"){var r=document.getElementById("admin-link");r&&(r.style.display="")}else o("admin-link");else o("dashboard-link"),o("admin-link"),l("login-link")}catch{o("dashboard-link"),o("admin-link"),l("login-link")}}var T={};w(T,{initCheckout:()=>H});function H(o){let{stripeKey:l,paypalClientId:r,courseId:s,currency:e}=o;if(typeof window.Stripe>"u"){console.error("Stripe.js not loaded");return}let t=window.Stripe(l),i=t.elements().create("card",{style:{base:{fontSize:"16px",color:"#1e293b","::placeholder":{color:"#94a3b8"}}}});document.getElementById("card-element")&&i.mount("#card-element"),i.on("change",y=>{let d=document.getElementById("card-errors");d&&(d.textContent=y.error?y.error.message:"")}),window.selectPaymentMethod=function(y){let d=document.getElementById("select-stripe"),n=document.getElementById("select-paypal"),c=document.getElementById("stripe-payment"),a=document.getElementById("paypal-payment");y==="stripe"?(d?.classList.add("active"),d&&(d.style.borderColor="#8b5cf6"),n?.classList.remove("active"),n&&(n.style.borderColor="#e2e8f0"),c&&(c.style.display="block"),a&&(a.style.display="none")):(n?.classList.add("active"),n&&(n.style.borderColor="#8b5cf6"),d?.classList.remove("active"),d&&(d.style.borderColor="#e2e8f0"),a&&(a.style.display="block"),c&&(c.style.display="none"),N(r,e,s))};let f=document.getElementById("payment-form");f&&f.addEventListener("submit",async y=>{y.preventDefault();let d=document.getElementById("submit-stripe"),n=document.getElementById("checkout-message"),c=d.innerHTML,a=document.getElementById("card-holder-name");d.disabled=!0,d.innerHTML='<i class="fas fa-spinner fa-spin"></i> Procesando...',n&&(n.style.display="none");try{let m=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:s,paymentMethod:"stripe"})}),{clientSecret:g,error:k}=await m.json();if(k)throw new Error(k);let h=await t.confirmCardPayment(g,{payment_method:{card:i,billing_details:{name:a.value}}});if(h.error)throw new Error(h.error.message);if((await(await fetch("/api/verify-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:h.paymentIntent.id,courseId:s})})).json()).success)window.location.href=`/pago-exitoso?courseId=${s}`;else throw new Error("Error al verificar el pago")}catch(m){n&&(n.className="auth-message error",n.textContent=m.message,n.style.display="block"),d.disabled=!1,d.innerHTML=c}})}function N(o,l,r){if(window.paypalLoaded)return;let s=document.createElement("script");s.src=`https://www.paypal.com/sdk/js?client-id=${o}&currency=${l}`,s.onload=()=>{window.paypalLoaded=!0,!(typeof window.paypal>"u")&&window.paypal.Buttons({createOrder:async()=>(await(await fetch("/api/create-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:r})})).json()).orderId,onApprove:async e=>{(await(await fetch("/api/capture-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:e.orderID,courseId:r})})).json()).success&&(window.location.href=`/pago-exitoso?courseId=${r}`)},onError:e=>{console.error(e);let t=document.getElementById("checkout-message");t&&(t.className="auth-message error",t.textContent="Error al procesar el pago con PayPal",t.style.display="block")}}).render("#paypal-button-container")},document.head.appendChild(s)}var I={};w(I,{initQuiz:()=>P});function P(o,l,r,s){let e=r*60,t,p=Date.now(),i=document.getElementById("quizForm");i&&(r>0&&(t=setInterval(()=>{e--;let u=Math.floor(e/60),f=e%60,y=u+":"+f.toString().padStart(2,"0"),d=document.getElementById("timerDisplay");d&&(d.textContent=y,d.classList.remove("warning","danger"),e<=60?d.classList.add("danger"):e<=180&&d.classList.add("warning")),e<=0&&(t&&clearInterval(t),alert("\xA1Tiempo agotado! La evaluaci\xF3n se enviar\xE1 autom\xE1ticamente."),i.dispatchEvent(new Event("submit")))},1e3)),i.addEventListener("submit",async u=>{if(u.preventDefault(),t&&clearInterval(t),e>0&&!confirm("\xBFEst\xE1s seguro de enviar la evaluaci\xF3n? No podr\xE1s cambiar tus respuestas.")){t&&(t=setInterval(()=>{e--},1e3));return}let f=new FormData(i),y={};for(let[a,m]of f.entries())if(a.startsWith("question_")){let g=a.replace("question_","");y[g]||(y[g]=[]),y[g].push(parseInt(m))}let d=Math.floor((Date.now()-p)/1e3),n=i.querySelector('button[type="submit"]'),c=n.innerHTML;try{n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Enviando...';let m=await(await fetch("/api/quiz/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({quizId:o,courseId:l,answers:y,timeTaken:d})})).json();m.success?window.location.href=`/cursos/${s}/quiz/${o}/resultado/${m.attemptId}`:(alert("Error: "+(m.error||"No se pudo enviar la evaluaci\xF3n")),n.disabled=!1,n.innerHTML=c)}catch(a){console.error("Error:",a),alert("Error al enviar la evaluaci\xF3n. Por favor, intenta de nuevo."),n.disabled=!1,n.innerHTML=c}}),window.addEventListener("beforeunload",u=>{u.preventDefault(),u.returnValue=""}))}var L={};w(L,{initCompletion:()=>j,initNotes:()=>q,initVideoTracking:()=>O});function O(o,l,r,s){let e=0,t=s||0,p=!1,i,u=async(n,c)=>{try{await fetch(`/api/lessons/${o}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position:Math.round(n),duration:Math.round(c),courseId:l})})}catch(a){console.error("Error saving video progress:",a)}};function f(){let n=document.querySelector("iframe");if(!(!n||!n.src.includes("youtube.com"))){if(!window.YT){let c=document.createElement("script");c.src="https://www.youtube.com/iframe_api";let a=document.getElementsByTagName("script")[0];a&&a.parentNode&&a.parentNode.insertBefore(c,a)}window.onYouTubeIframeAPIReady=function(){new window.YT.Player(n,{events:{onReady:function(c){p=!0,t=c.target.getDuration(),r>0&&r<t-5&&(c.target.seekTo(r,!0),console.log("Restored video position:",r)),i=setInterval(()=>{try{let a=c.target.getCurrentTime(),m=c.target.getDuration();a>0&&m>0&&(e=a,t=m,u(a,m))}catch(a){console.error("Error tracking YouTube progress:",a)}},1e4)},onStateChange:function(c){if(c.data===window.YT.PlayerState.PAUSED||c.data===window.YT.PlayerState.ENDED){let a=c.target.getCurrentTime(),m=c.target.getDuration();u(a,m)}c.data===window.YT.PlayerState.ENDED&&document.dispatchEvent(new CustomEvent("video-ended"))}}})},window.YT&&window.YT.Player&&window.onYouTubeIframeAPIReady()}}function y(){let n=document.querySelector("iframe");if(!n||!n.src.includes("vimeo.com"))return;if(window.Vimeo)c();else{let a=document.createElement("script");a.src="https://player.vimeo.com/api/player.js",a.onload=c,document.head.appendChild(a)}function c(){let a=new window.Vimeo.Player(n);a.ready().then(()=>{p=!0,a.getDuration().then(m=>{t=m,r>0&&r<m-5&&a.setCurrentTime(r)}),a.on("timeupdate",m=>{e=m.seconds,t=m.duration}),i=setInterval(()=>{e>0&&t>0&&u(e,t)},1e4),a.on("ended",()=>{u(e,t),document.dispatchEvent(new CustomEvent("video-ended"))})})}}function d(){let n=document.querySelector("video");n&&(n.addEventListener("loadedmetadata",()=>{p=!0,t=n.duration,r>0&&r<n.duration-5&&(n.currentTime=r)}),n.addEventListener("timeupdate",()=>{e=n.currentTime,t=n.duration}),i=setInterval(()=>{n.currentTime>0&&n.duration>0&&u(n.currentTime,n.duration)},1e4),n.addEventListener("ended",()=>{u(n.currentTime,n.duration),document.dispatchEvent(new CustomEvent("video-ended"))}))}setTimeout(()=>{f(),y(),d()},1e3),window.addEventListener("beforeunload",()=>{if(e>0&&t>0){let n=JSON.stringify({position:Math.round(e),duration:Math.round(t),courseId:l});navigator.sendBeacon(`/api/lessons/${o}/progress`,n)}}),window.addEventListener("unload",()=>{i&&clearInterval(i)})}function j(o,l,r){let s=r,e=document.getElementById("completeBtn");if(!e)return;let t=async()=>{try{e.setAttribute("disabled","true");let i=await(await fetch(`/api/lessons/${o}/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:!s,courseId:l})})).json();if(i.success){if(s=!s,e.innerHTML=s?'<i class="fas fa-check-circle"></i> Completada':'<i class="far fa-circle"></i> Marcar Completa',e.style.background=s?"#10b981":"#64748b",i.certificateGenerated&&i.certificateId&&confirm("\xA1Felicitaciones! Has completado el curso al 100%. Tu certificado ha sido generado. \xBFDeseas verlo ahora?")){window.location.href="/certificado/"+i.certificateId;return}setTimeout(()=>window.location.reload(),500)}else alert("Error al actualizar el progreso")}catch(p){console.error("Error:",p),alert("Error al actualizar el progreso")}finally{e.removeAttribute("disabled")}};e.addEventListener("click",t),document.addEventListener("video-ended",()=>{s||setTimeout(t,1e3)})}function q(o,l){let r=document.getElementById("notesArea"),s=async()=>{try{let p=r.value,i=document.getElementById("saveStatus");(await(await fetch(`/api/lessons/${o}/notes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:p,courseId:l})})).json()).success?i&&(i.style.display="inline",setTimeout(()=>i.style.display="none",3e3)):alert("Error al guardar notas")}catch(p){console.error("Error:",p),alert("Error al guardar notas")}},e;r?.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(s,3e4)});let t=document.getElementById("saveNotesBtn");t&&t.addEventListener("click",s)}var C={};w(C,{initCertificate:()=>B});function B(){let o=document.getElementById("downloadPdfBtn");o&&o.addEventListener("click",()=>{alert('Usa el bot\xF3n de imprimir y selecciona "Guardar como PDF" en tu navegador.'),window.print()})}window.ADM={auth:v,stripe:T,quiz:I,video:L,certificate:C};document.addEventListener("DOMContentLoaded",()=>{b(),E(),B()});})();
//# sourceMappingURL=client.js.map
