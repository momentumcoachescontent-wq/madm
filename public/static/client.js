"use strict";(()=>{var M=Object.defineProperty;var b=(a,p)=>{for(var r in p)M(a,r,{get:p[r],enumerable:!0})};var T={};b(T,{checkAuth:()=>v,initLogin:()=>P,initLogout:()=>E,initRegister:()=>H,logout:()=>S});function P(a="login-form",p="auth-message"){let r=document.getElementById(a);r&&r.addEventListener("submit",async s=>{s.preventDefault();let e=document.getElementById(p),t=r.querySelector('button[type="submit"]'),l=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Iniciando sesi\xF3n...',e&&(e.style.display="none");let c=new FormData(r);try{let f=await(await fetch("/api/login",{method:"POST",body:c})).json();if(f.success)e&&(e.className="auth-message success",e.textContent="\xA1Bienvenido! Redirigiendo...",e.style.display="block"),setTimeout(()=>{window.location.href="/mi-aprendizaje"},1e3);else throw new Error(f.error||"Error al iniciar sesi\xF3n")}catch(y){e&&(e.className="auth-message error",e.textContent=y.message,e.style.display="block"),t.disabled=!1,t.innerHTML=l}})}function H(a="register-form",p="auth-message"){let r=document.getElementById(a);r&&r.addEventListener("submit",async s=>{s.preventDefault();let e=document.getElementById(p),t=r.querySelector('button[type="submit"]'),l=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creando cuenta...',e&&(e.style.display="none");let c=new FormData(r);try{let f=await(await fetch("/api/register",{method:"POST",body:c})).json();if(f.success)e&&(e.className="auth-message success",e.textContent="\xA1Cuenta creada! Redirigiendo...",e.style.display="block"),setTimeout(()=>{window.location.href="/mi-aprendizaje"},1e3);else throw new Error(f.error||"Error al crear cuenta")}catch(y){e&&(e.className="auth-message error",e.textContent=y.message,e.style.display="block"),t.disabled=!1,t.innerHTML=l}})}async function S(){if(confirm("\xBFEst\xE1s seguro que deseas cerrar sesi\xF3n?"))try{(await fetch("/api/logout",{method:"POST"})).ok&&(window.location.href="/")}catch(a){console.error("Error al cerrar sesi\xF3n:",a),alert("Error al cerrar sesi\xF3n. Por favor, intenta de nuevo.")}}function E(){let a=document.getElementById("logoutBtn");a&&a.addEventListener("click",S)}async function v(){function a(s){var e=document.getElementById(s);e&&e.remove()}function p(s,e){var t=document.getElementById(s);t&&(t.style.display=e||"inline-flex")}try{let e=await(await fetch("/api/me")).json();if(e.success&&e.user)if(a("login-link"),a("start-link"),p("dashboard-link"),e.user.role==="admin"){var r=document.getElementById("admin-link");r&&(r.style.display="")}else a("admin-link");else a("dashboard-link"),a("admin-link"),p("login-link")}catch{a("dashboard-link"),a("admin-link"),p("login-link")}}var I={};b(I,{initCheckout:()=>N});function N(a){let{stripeKey:p,paypalClientId:r,courseId:s,currency:e}=a;if(typeof window.Stripe>"u"){console.error("Stripe.js not loaded");return}let t=window.Stripe(p),c=t.elements().create("card",{style:{base:{fontSize:"16px",color:"#1e293b","::placeholder":{color:"#94a3b8"}}}});document.getElementById("card-element")&&c.mount("#card-element"),c.on("change",g=>{let u=document.getElementById("card-errors");u&&(u.textContent=g.error?g.error.message:"")}),window.selectPaymentMethod=function(g){let u=document.getElementById("select-stripe"),n=document.getElementById("select-paypal"),d=document.getElementById("stripe-payment"),i=document.getElementById("paypal-payment");g==="stripe"?(u?.classList.add("active"),u&&(u.style.borderColor="#8b5cf6"),n?.classList.remove("active"),n&&(n.style.borderColor="#e2e8f0"),d&&(d.style.display="block"),i&&(i.style.display="none")):(n?.classList.add("active"),n&&(n.style.borderColor="#8b5cf6"),u?.classList.remove("active"),u&&(u.style.borderColor="#e2e8f0"),i&&(i.style.display="block"),d&&(d.style.display="none"),x(r,e,s))};let f=document.getElementById("payment-form");f&&f.addEventListener("submit",async g=>{g.preventDefault();let u=document.getElementById("submit-stripe"),n=document.getElementById("checkout-message"),d=document.getElementById("card-holder-name");if(!u||!d){console.error("Missing required elements for payment processing");return}let i=u.innerHTML;u.disabled=!0,u.innerHTML='<i class="fas fa-spinner fa-spin"></i> Procesando...',n&&(n.style.display="none");try{let o=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:s,paymentMethod:"stripe"})}),{clientSecret:m,error:w}=await o.json();if(w)throw new Error(w);let h=await t.confirmCardPayment(m,{payment_method:{card:c,billing_details:{name:d.value}}});if(h.error)throw new Error(h.error.message);if((await(await fetch("/api/verify-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:h.paymentIntent.id,courseId:s})})).json()).success)window.location.href=`/pago-exitoso?courseId=${s}`;else throw new Error("Error al verificar el pago")}catch(o){n&&(n.className="auth-message error",n.textContent=o.message,n.style.display="block"),u.disabled=!1,u.innerHTML=i}})}function x(a,p,r){if(window.paypalLoaded)return;let s=document.createElement("script");s.src=`https://www.paypal.com/sdk/js?client-id=${a}&currency=${p}`,s.onload=()=>{window.paypalLoaded=!0,!(typeof window.paypal>"u")&&window.paypal.Buttons({createOrder:async()=>{try{let e=await fetch("/api/create-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:r})});if(!e.ok)throw new Error("Network response was not ok");let t=await e.json();if(!t.orderId)throw new Error("No order ID received");return t.orderId}catch(e){throw console.error("Error creating PayPal order:",e),e}},onApprove:async e=>{try{let t=await fetch("/api/capture-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:e.orderID,courseId:r})});if(!t.ok)throw new Error("Network response was not ok");let l=await t.json();if(l.success)window.location.href=`/pago-exitoso?courseId=${r}`;else throw new Error(l.error||"Payment capture failed")}catch(t){console.error("Error capturing PayPal order:",t);let l=document.getElementById("checkout-message");l&&(l.className="auth-message error",l.textContent=t.message||"Error al procesar el pago con PayPal",l.style.display="block")}},onError:e=>{console.error(e);let t=document.getElementById("checkout-message");t&&(t.className="auth-message error",t.textContent="Error al procesar el pago con PayPal",t.style.display="block")}}).render("#paypal-button-container")},document.head.appendChild(s)}var L={};b(L,{initQuiz:()=>j});function j(a,p,r,s){let e=r*60,t,l=Date.now(),c=document.getElementById("quizForm");if(!c)return;let y=()=>{e--;let f=Math.floor(e/60),g=e%60,u=f+":"+g.toString().padStart(2,"0"),n=document.getElementById("timerDisplay");n&&(n.textContent=u,n.classList.remove("warning","danger"),e<=60?n.classList.add("danger"):e<=180&&n.classList.add("warning")),e<=0&&(t&&clearInterval(t),alert("\xA1Tiempo agotado! La evaluaci\xF3n se enviar\xE1 autom\xE1ticamente."),c.dispatchEvent(new Event("submit")))};r>0&&(t&&clearInterval(t),t=setInterval(y,1e3)),c.addEventListener("submit",async f=>{if(f.preventDefault(),t&&clearInterval(t),e>0&&!confirm("\xBFEst\xE1s seguro de enviar la evaluaci\xF3n? No podr\xE1s cambiar tus respuestas.")){r>0&&(t&&clearInterval(t),t=setInterval(y,1e3));return}let g=new FormData(c),u={};for(let[o,m]of g.entries())if(o.startsWith("question_")){let w=o.replace("question_","");u[w]||(u[w]=[]),u[w].push(parseInt(m))}let n=Math.floor((Date.now()-l)/1e3),d=c.querySelector('button[type="submit"]'),i=d.innerHTML;try{d.disabled=!0,d.innerHTML='<i class="fas fa-spinner fa-spin"></i> Enviando...';let m=await(await fetch("/api/quiz/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({quizId:a,courseId:p,answers:u,timeTaken:n})})).json();m.success?window.location.href=`/cursos/${s}/quiz/${a}/resultado/${m.attemptId}`:(alert("Error: "+(m.error||"No se pudo enviar la evaluaci\xF3n")),d.disabled=!1,d.innerHTML=i)}catch(o){console.error("Error:",o),alert("Error al enviar la evaluaci\xF3n. Por favor, intenta de nuevo."),d.disabled=!1,d.innerHTML=i}}),window.addEventListener("beforeunload",f=>{f.preventDefault(),f.returnValue=""})}var B={};b(B,{initCompletion:()=>q,initNotes:()=>R,initVideoTracking:()=>O});function O(a,p,r,s){let e=0,t=s||0,l=!1,c,y=async(n,d)=>{try{await fetch(`/api/lessons/${a}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position:Math.round(n),duration:Math.round(d),courseId:p})})}catch(i){console.error("Error saving video progress:",i)}};function f(){let n=i=>{try{let o=new URL(i,window.location.origin),m=o.protocol;if(m!=="https:"&&m!=="http:")return!1;let w=o.hostname.toLowerCase();return["youtube.com","www.youtube.com","m.youtube.com","youtu.be"].includes(w)||w.endsWith(".youtube.com")}catch{return!1}},d=document.querySelector("iframe");if(!(!d||!n(d.src))){if(!window.YT){let i=document.createElement("script");i.src="https://www.youtube.com/iframe_api";let o=document.getElementsByTagName("script")[0];o&&o.parentNode&&o.parentNode.insertBefore(i,o)}window.onYouTubeIframeAPIReady=function(){new window.YT.Player(d,{events:{onReady:function(i){l=!0,t=i.target.getDuration(),r>0&&r<t-5&&(i.target.seekTo(r,!0),console.log("Restored video position:",r)),c=setInterval(()=>{try{let o=i.target.getCurrentTime(),m=i.target.getDuration();o>0&&m>0&&(e=o,t=m,y(o,m))}catch(o){console.error("Error tracking YouTube progress:",o)}},1e4)},onStateChange:function(i){if(i.data===window.YT.PlayerState.PAUSED||i.data===window.YT.PlayerState.ENDED){let o=i.target.getCurrentTime(),m=i.target.getDuration();y(o,m)}i.data===window.YT.PlayerState.ENDED&&document.dispatchEvent(new CustomEvent("video-ended"))}}})},window.YT&&window.YT.Player&&window.onYouTubeIframeAPIReady()}}function g(){let n=o=>{try{let m=new URL(o,window.location.origin),w=m.protocol;if(w!=="https:"&&w!=="http:")return!1;let h=m.hostname.toLowerCase();return["vimeo.com","www.vimeo.com","player.vimeo.com"].includes(h)||h.endsWith(".vimeo.com")}catch{return!1}},d=document.querySelector("iframe");if(!d||!n(d.src))return;if(window.Vimeo)i();else{let o=document.createElement("script");o.src="https://player.vimeo.com/api/player.js",o.onload=i,document.head.appendChild(o)}function i(){let o=new window.Vimeo.Player(d);o.ready().then(()=>{l=!0,o.getDuration().then(m=>{t=m,r>0&&r<m-5&&o.setCurrentTime(r)}),o.on("timeupdate",m=>{e=m.seconds,t=m.duration}),c=setInterval(()=>{e>0&&t>0&&y(e,t)},1e4),o.on("ended",()=>{y(e,t),document.dispatchEvent(new CustomEvent("video-ended"))})})}}function u(){let n=document.querySelector("video");n&&(n.addEventListener("loadedmetadata",()=>{l=!0,t=n.duration,r>0&&r<n.duration-5&&(n.currentTime=r)}),n.addEventListener("timeupdate",()=>{e=n.currentTime,t=n.duration}),c=setInterval(()=>{n.currentTime>0&&n.duration>0&&y(n.currentTime,n.duration)},1e4),n.addEventListener("ended",()=>{y(n.currentTime,n.duration),document.dispatchEvent(new CustomEvent("video-ended"))}))}setTimeout(()=>{f(),g(),u()},1e3),window.addEventListener("beforeunload",()=>{if(e>0&&t>0){let n=JSON.stringify({position:Math.round(e),duration:Math.round(t),courseId:p}),d=new Blob([n],{type:"application/json"});navigator.sendBeacon(`/api/lessons/${a}/progress`,d)}}),window.addEventListener("unload",()=>{c&&clearInterval(c)})}function q(a,p,r){let s=r,e=document.getElementById("completeBtn");if(!e)return;let t=async()=>{try{e.setAttribute("disabled","true");let c=await(await fetch(`/api/lessons/${a}/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:!s,courseId:p})})).json();if(c.success){if(s=!s,e.innerHTML=s?'<i class="fas fa-check-circle"></i> Completada':'<i class="far fa-circle"></i> Marcar Completa',e.style.background=s?"#10b981":"#64748b",c.certificateGenerated&&c.certificateId&&confirm("\xA1Felicitaciones! Has completado el curso al 100%. Tu certificado ha sido generado. \xBFDeseas verlo ahora?")){window.location.href="/certificado/"+c.certificateId;return}setTimeout(()=>window.location.reload(),500)}else alert("Error al actualizar el progreso")}catch(l){console.error("Error:",l),alert("Error al actualizar el progreso")}finally{e.removeAttribute("disabled")}};e.addEventListener("click",t),document.addEventListener("video-ended",()=>{s||setTimeout(t,1e3)})}function R(a,p){let r=document.getElementById("notesArea"),s=async()=>{if(r)try{let l=r.value,c=document.getElementById("saveStatus");(await(await fetch(`/api/lessons/${a}/notes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:l,courseId:p})})).json()).success?c&&(c.style.display="inline",setTimeout(()=>c.style.display="none",3e3)):alert("Error al guardar notas")}catch(l){console.error("Error:",l),alert("Error al guardar notas")}},e;r&&r.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(s,3e4)});let t=document.getElementById("saveNotesBtn");t&&t.addEventListener("click",s)}var C={};b(C,{initCertificate:()=>k});function k(){let a=document.getElementById("downloadPdfBtn");a&&a.addEventListener("click",()=>{alert('Usa el bot\xF3n de imprimir y selecciona "Guardar como PDF" en tu navegador.'),window.print()})}window.ADM={auth:T,stripe:I,quiz:L,video:B,certificate:C};document.addEventListener("DOMContentLoaded",()=>{v(),E(),k()});})();
//# sourceMappingURL=client.js.map
