"use strict";(()=>{var $=Object.defineProperty;var h=(n,c)=>{for(var r in c)$(n,r,{get:c[r],enumerable:!0})};var T={};h(T,{checkAuth:()=>v,init:()=>I,initLogin:()=>N,initLogout:()=>b,initRegister:()=>O,logout:()=>j});function N(n="login-form",c="auth-message"){let r=document.getElementById(n);r&&r.addEventListener("submit",async i=>{i.preventDefault();let e=document.getElementById(c),t=r.querySelector('button[type="submit"]'),u=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Iniciando sesi\xF3n...',e&&(e.style.display="none");let l=new FormData(r);try{let p=await(await fetch("/api/login",{method:"POST",body:l})).json();if(p.success){e&&(e.className="auth-message success",e.textContent="\xA1Bienvenido! Redirigiendo...",e.style.display="block");let s=new URLSearchParams(window.location.search).get("redirect");s&&(!s.startsWith("/")||s.startsWith("//")||s.includes("\\")||s.includes("://"))&&(s=null),setTimeout(()=>{window.location.href=s||"/mi-aprendizaje"},1e3)}else throw new Error(p.error||"Error al iniciar sesi\xF3n")}catch(f){e&&(e.className="auth-message error",e.textContent=f.message,e.style.display="block"),t.disabled=!1,t.innerHTML=u}})}function O(n="register-form",c="auth-message"){let r=document.getElementById(n);r&&r.addEventListener("submit",async i=>{i.preventDefault();let e=document.getElementById(c),t=r.querySelector('button[type="submit"]'),u=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creando cuenta...',e&&(e.style.display="none");let l=new FormData(r);try{let p=await(await fetch("/api/register",{method:"POST",body:l})).json();if(p.success)e&&(e.className="auth-message success",e.textContent="\xA1Cuenta creada! Redirigiendo...",e.style.display="block"),setTimeout(()=>{window.location.href="/mi-aprendizaje"},1e3);else throw new Error(p.error||"Error al crear cuenta")}catch(f){e&&(e.className="auth-message error",e.textContent=f.message,e.style.display="block"),t.disabled=!1,t.innerHTML=u}})}async function j(){if(confirm("\xBFEst\xE1s seguro que deseas cerrar sesi\xF3n?"))try{(await fetch("/api/logout",{method:"POST"})).ok&&(window.location.href="/")}catch(n){console.error("Error al cerrar sesi\xF3n:",n),alert("Error al cerrar sesi\xF3n. Por favor, intenta de nuevo.")}}function b(){let n=document.getElementById("logoutBtn");n&&n.addEventListener("click",j)}async function v(){function n(i){var e=document.getElementById(i);e&&e.remove()}function c(i,e){var t=document.getElementById(i);t&&(t.style.display=e||"inline-flex")}try{let e=await(await fetch("/api/me")).json();if(e.success&&e.user)if(n("login-link"),n("start-link"),c("dashboard-link"),e.user.role==="admin"){var r=document.getElementById("admin-link");r&&(r.style.display="")}else n("admin-link");else n("dashboard-link"),n("admin-link"),c("login-link")}catch{n("dashboard-link"),n("admin-link"),c("login-link")}}function I(){document.getElementById("login-form")&&N(),document.getElementById("register-form")&&O()}var L={};h(L,{init:()=>B,initCheckout:()=>A});function A(n){let{stripeKey:c,paypalClientId:r,courseId:i,currency:e}=n;if(typeof window.Stripe>"u"){let t=setInterval(()=>{typeof window.Stripe<"u"&&(clearInterval(t),q(n))},100);setTimeout(()=>clearInterval(t),1e4);return}q(n)}function q(n){let{stripeKey:c,paypalClientId:r,courseId:i,currency:e}=n,t=window.Stripe(c),l=t.elements().create("card",{style:{base:{fontSize:"16px",color:"#1e293b","::placeholder":{color:"#94a3b8"}}}});document.getElementById("card-element")&&l.mount("#card-element"),l.on("change",m=>{let o=document.getElementById("card-errors");o&&(o.textContent=m.error?m.error.message:"")}),window.selectPaymentMethod=function(m){let o=document.getElementById("select-stripe"),a=document.getElementById("select-paypal"),d=document.getElementById("stripe-payment"),y=document.getElementById("paypal-payment");m==="stripe"?(o?.classList.add("active"),o&&(o.style.borderColor="#8b5cf6"),a?.classList.remove("active"),a&&(a.style.borderColor="#e2e8f0"),d&&(d.style.display="block"),y&&(y.style.display="none")):(a?.classList.add("active"),a&&(a.style.borderColor="#8b5cf6"),o?.classList.remove("active"),o&&(o.style.borderColor="#e2e8f0"),y&&(y.style.display="block"),d&&(d.style.display="none"),F(r,e,i))};let p=document.getElementById("select-stripe");p&&!p.getAttribute("onclick")&&p.addEventListener("click",()=>window.selectPaymentMethod("stripe"));let g=document.getElementById("select-paypal");g&&!g.getAttribute("onclick")&&g.addEventListener("click",()=>window.selectPaymentMethod("paypal"));let s=document.getElementById("payment-form");s&&s.addEventListener("submit",async m=>{m.preventDefault();let o=document.getElementById("submit-stripe"),a=document.getElementById("checkout-message"),d=document.getElementById("card-holder-name");if(!o||!d){console.error("Missing required elements for payment processing");return}let y=o.innerHTML;o.disabled=!0,o.innerHTML='<i class="fas fa-spinner fa-spin"></i> Procesando...',a&&(a.style.display="none");try{let w=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:i,paymentMethod:"stripe"})}),{clientSecret:x,error:H}=await w.json();if(H)throw new Error(H);let E=await t.confirmCardPayment(x,{payment_method:{card:l,billing_details:{name:d.value}}});if(E.error)throw new Error(E.error.message);if((await(await fetch("/api/verify-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:E.paymentIntent.id,courseId:i})})).json()).success)window.location.href=`/pago-exitoso?courseId=${i}`;else throw new Error("Error al verificar el pago")}catch(w){a&&(a.className="auth-message error",a.textContent=w.message,a.style.display="block"),o.disabled=!1,o.innerHTML=y}})}function F(n,c,r){if(window.paypalLoaded)return;let i=document.createElement("script");i.src=`https://www.paypal.com/sdk/js?client-id=${n}&currency=${c}`,i.onload=()=>{window.paypalLoaded=!0,!(typeof window.paypal>"u")&&window.paypal.Buttons({createOrder:async()=>{try{let e=await fetch("/api/create-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:r})});if(!e.ok)throw new Error("Network response was not ok");let t=await e.json();if(!t.orderId)throw new Error("No order ID received");return t.orderId}catch(e){throw console.error("Error creating PayPal order:",e),e}},onApprove:async e=>{try{let t=await fetch("/api/capture-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:e.orderID,courseId:r})});if(!t.ok)throw new Error("Network response was not ok");let u=await t.json();if(u.success)window.location.href=`/pago-exitoso?courseId=${r}`;else throw new Error(u.error||"Payment capture failed")}catch(t){console.error("Error capturing PayPal order:",t);let u=document.getElementById("checkout-message");u&&(u.className="auth-message error",u.textContent=t.message||"Error al procesar el pago con PayPal",u.style.display="block")}},onError:e=>{console.error(e);let t=document.getElementById("checkout-message");t&&(t.className="auth-message error",t.textContent="Error al procesar el pago con PayPal",t.style.display="block")}}).render("#paypal-button-container")},document.head.appendChild(i)}function B(){let n=document.getElementById("checkout-config");if(n){let c={stripeKey:n.dataset.stripeKey,paypalClientId:n.dataset.paypalClientId,courseId:parseInt(n.dataset.courseId),currency:n.dataset.currency,price:parseFloat(n.dataset.price)};A(c)}}var C={};h(C,{init:()=>k,initQuiz:()=>R});function R(n,c,r,i){let e=r*60,t,u=Date.now(),l=document.getElementById("quizForm");if(!l)return;let f=()=>{e--;let p=Math.floor(e/60),g=e%60,s=p+":"+g.toString().padStart(2,"0"),m=document.getElementById("timerDisplay");m&&(m.textContent=s,m.classList.remove("warning","danger"),e<=60?m.classList.add("danger"):e<=180&&m.classList.add("warning")),e<=0&&(t&&clearInterval(t),alert("\xA1Tiempo agotado! La evaluaci\xF3n se enviar\xE1 autom\xE1ticamente."),l.dispatchEvent(new Event("submit")))};r>0&&(t&&clearInterval(t),t=setInterval(f,1e3)),l.addEventListener("submit",async p=>{if(p.preventDefault(),t&&clearInterval(t),e>0&&!confirm("\xBFEst\xE1s seguro de enviar la evaluaci\xF3n? No podr\xE1s cambiar tus respuestas.")){r>0&&(t&&clearInterval(t),t=setInterval(f,1e3));return}let g=new FormData(l),s={};for(let[d,y]of g.entries())if(d.startsWith("question_")){let w=d.replace("question_","");s[w]||(s[w]=[]),s[w].push(parseInt(y))}let m=Math.floor((Date.now()-u)/1e3),o=l.querySelector('button[type="submit"]'),a=o.innerHTML;try{o.disabled=!0,o.innerHTML='<i class="fas fa-spinner fa-spin"></i> Enviando...';let y=await(await fetch("/api/quiz/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({quizId:n,courseId:c,answers:s,timeTaken:m})})).json();y.success?window.location.href=`/cursos/${i}/quiz/${n}/resultado/${y.attemptId}`:(alert("Error: "+(y.error||"No se pudo enviar la evaluaci\xF3n")),o.disabled=!1,o.innerHTML=a)}catch(d){console.error("Error:",d),alert("Error al enviar la evaluaci\xF3n. Por favor, intenta de nuevo."),o.disabled=!1,o.innerHTML=a}}),window.addEventListener("beforeunload",p=>{l.querySelector('button[type="submit"]').disabled||(p.preventDefault(),p.returnValue="")})}function k(){let n=document.getElementById("quiz-config");if(n){let c=parseInt(n.dataset.quizId),r=parseInt(n.dataset.courseId),i=parseInt(n.dataset.timeLimit),e=n.dataset.slug;R(c,r,i,e)}}var D={};h(D,{init:()=>S,initCompletion:()=>Y,initNotes:()=>V,initVideoTracking:()=>z});function z(n,c,r,i){let e=0,t=i||0,u,l=async(s,m)=>{try{await fetch(`/api/lessons/${n}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position:Math.round(s),duration:Math.round(m),courseId:c})})}catch(o){console.error("Error saving video progress:",o)}};function f(){let s=o=>{try{let a=new URL(o,window.location.origin),d=a.protocol;if(d!=="https:"&&d!=="http:")return!1;let y=a.hostname.toLowerCase();return["youtube.com","www.youtube.com","m.youtube.com","youtu.be"].includes(y)||y.endsWith(".youtube.com")}catch{return!1}},m=document.querySelector("iframe");if(!(!m||!s(m.src))){if(!window.YT){let o=document.createElement("script");o.src="https://www.youtube.com/iframe_api";let a=document.getElementsByTagName("script")[0];a&&a.parentNode&&a.parentNode.insertBefore(o,a)}window.onYouTubeIframeAPIReady=function(){new window.YT.Player(m,{events:{onReady:function(o){t=o.target.getDuration(),r>0&&r<t-5&&(o.target.seekTo(r,!0),console.log("Restored video position:",r)),u=setInterval(()=>{try{let a=o.target.getCurrentTime(),d=o.target.getDuration();a>0&&d>0&&(e=a,t=d,l(a,d))}catch(a){console.error("Error tracking YouTube progress:",a)}},1e4)},onStateChange:function(o){if(o.data===window.YT.PlayerState.PAUSED||o.data===window.YT.PlayerState.ENDED){let a=o.target.getCurrentTime(),d=o.target.getDuration();l(a,d)}o.data===window.YT.PlayerState.ENDED&&document.dispatchEvent(new CustomEvent("video-ended"))}}})},window.YT&&window.YT.Player&&window.onYouTubeIframeAPIReady()}}function p(){let s=a=>{try{let d=new URL(a,window.location.origin),y=d.protocol;if(y!=="https:"&&y!=="http:")return!1;let w=d.hostname.toLowerCase();return["vimeo.com","www.vimeo.com","player.vimeo.com"].includes(w)||w.endsWith(".vimeo.com")}catch{return!1}},m=document.querySelector("iframe");if(!m||!s(m.src))return;if(window.Vimeo)o();else{let a=document.createElement("script");a.src="https://player.vimeo.com/api/player.js",a.onload=o,document.head.appendChild(a)}function o(){let a=new window.Vimeo.Player(m);a.ready().then(()=>{a.getDuration().then(d=>{t=d,r>0&&r<d-5&&a.setCurrentTime(r)}),a.on("timeupdate",d=>{e=d.seconds,t=d.duration}),u=setInterval(()=>{e>0&&t>0&&l(e,t)},1e4),a.on("ended",()=>{l(e,t),document.dispatchEvent(new CustomEvent("video-ended"))})})}}function g(){let s=document.querySelector("video");s&&(s.addEventListener("loadedmetadata",()=>{t=s.duration,r>0&&r<s.duration-5&&(s.currentTime=r)}),s.addEventListener("timeupdate",()=>{e=s.currentTime,t=s.duration}),u=setInterval(()=>{s.currentTime>0&&s.duration>0&&l(s.currentTime,s.duration)},1e4),s.addEventListener("ended",()=>{l(s.currentTime,s.duration),document.dispatchEvent(new CustomEvent("video-ended"))}))}setTimeout(()=>{f(),p(),g()},1e3),window.addEventListener("beforeunload",()=>{if(e>0&&t>0){let s=JSON.stringify({position:Math.round(e),duration:Math.round(t),courseId:c}),m=new Blob([s],{type:"application/json"});navigator.sendBeacon(`/api/lessons/${n}/progress`,m)}}),window.addEventListener("unload",()=>{u&&clearInterval(u)})}function Y(n,c,r){let i=r,e=document.getElementById("completeBtn");if(!e)return;let t=async()=>{try{e.setAttribute("disabled","true");let l=await(await fetch(`/api/lessons/${n}/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:!i,courseId:c})})).json();if(l.success){if(i=!i,e.innerHTML=i?'<i class="fas fa-check-circle"></i> Completada':'<i class="far fa-circle"></i> Marcar Completa',e.style.background=i?"#10b981":"#64748b",l.certificateGenerated&&l.certificateId&&confirm("\xA1Felicitaciones! Has completado el curso al 100%. Tu certificado ha sido generado. \xBFDeseas verlo ahora?")){window.location.href="/certificado/"+l.certificateId;return}setTimeout(()=>window.location.reload(),500)}else alert("Error al actualizar el progreso")}catch(u){console.error("Error:",u),alert("Error al actualizar el progreso")}finally{e.removeAttribute("disabled")}};e.addEventListener("click",t),document.addEventListener("video-ended",()=>{i||setTimeout(t,1e3)})}function V(n,c){let r=document.getElementById("notesArea"),i=async()=>{if(r)try{let u=r.value,l=document.getElementById("saveStatus");(await(await fetch(`/api/lessons/${n}/notes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:u,courseId:c})})).json()).success?l&&(l.style.display="inline",setTimeout(()=>l.style.display="none",3e3)):alert("Error al guardar notas")}catch(u){console.error("Error:",u),alert("Error al guardar notas")}},e;r&&r.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(i,3e4)});let t=document.getElementById("saveNotesBtn");t&&t.addEventListener("click",i)}function S(){let n=document.getElementById("video-config");if(n){let c=parseInt(n.dataset.lessonId),r=parseInt(n.dataset.courseId),i=parseInt(n.dataset.lastPosition),e=parseInt(n.dataset.duration),t=n.dataset.isCompleted==="true";z(c,r,i,e),Y(c,r,t),V(c,r)}}var P={};h(P,{initCertificate:()=>M});function M(){let n=document.getElementById("downloadPdfBtn");n&&n.addEventListener("click",()=>{alert('Usa el bot\xF3n de imprimir y selecciona "Guardar como PDF" en tu navegador.'),window.print()})}window.ADM={auth:T,stripe:L,quiz:C,video:D,certificate:P};document.addEventListener("DOMContentLoaded",()=>{v(),b(),I(),B(),k(),M(),S()});})();
//# sourceMappingURL=client.js.map
