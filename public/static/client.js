"use strict";(()=>{var $=Object.defineProperty;var E=(n,d)=>{for(var r in d)$(n,r,{get:d[r],enumerable:!0})};var L={};E(L,{checkAuth:()=>T,init:()=>B,initLogin:()=>N,initLogout:()=>I,initRegister:()=>O,logout:()=>j});function N(n="login-form",d="auth-message"){let r=document.getElementById(n);r&&r.addEventListener("submit",async s=>{s.preventDefault();let e=document.getElementById(d),t=r.querySelector('button[type="submit"]'),m=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Iniciando sesi\xF3n...',e&&(e.style.display="none");let u=new FormData(r);try{let p=await(await fetch("/api/login",{method:"POST",body:u})).json();if(p.success){e&&(e.className="auth-message success",e.textContent="\xA1Bienvenido! Redirigiendo...",e.style.display="block");let f=new URLSearchParams(window.location.search).get("redirect");setTimeout(()=>{window.location.href=f||"/mi-aprendizaje"},1e3)}else throw new Error(p.error||"Error al iniciar sesi\xF3n")}catch(y){e&&(e.className="auth-message error",e.textContent=y.message,e.style.display="block"),t.disabled=!1,t.innerHTML=m}})}function O(n="register-form",d="auth-message"){let r=document.getElementById(n);r&&r.addEventListener("submit",async s=>{s.preventDefault();let e=document.getElementById(d),t=r.querySelector('button[type="submit"]'),m=t.innerHTML;t.disabled=!0,t.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creando cuenta...',e&&(e.style.display="none");let u=new FormData(r);try{let p=await(await fetch("/api/register",{method:"POST",body:u})).json();if(p.success)e&&(e.className="auth-message success",e.textContent="\xA1Cuenta creada! Redirigiendo...",e.style.display="block"),setTimeout(()=>{window.location.href="/mi-aprendizaje"},1e3);else throw new Error(p.error||"Error al crear cuenta")}catch(y){e&&(e.className="auth-message error",e.textContent=y.message,e.style.display="block"),t.disabled=!1,t.innerHTML=m}})}async function j(){if(confirm("\xBFEst\xE1s seguro que deseas cerrar sesi\xF3n?"))try{(await fetch("/api/logout",{method:"POST"})).ok&&(window.location.href="/")}catch(n){console.error("Error al cerrar sesi\xF3n:",n),alert("Error al cerrar sesi\xF3n. Por favor, intenta de nuevo.")}}function I(){let n=document.getElementById("logoutBtn");n&&n.addEventListener("click",j)}async function T(){function n(s){var e=document.getElementById(s);e&&e.remove()}function d(s,e){var t=document.getElementById(s);t&&(t.style.display=e||"inline-flex")}try{let e=await(await fetch("/api/me")).json();if(e.success&&e.user)if(n("login-link"),n("start-link"),d("dashboard-link"),e.user.role==="admin"){var r=document.getElementById("admin-link");r&&(r.style.display="")}else n("admin-link");else n("dashboard-link"),n("admin-link"),d("login-link")}catch{n("dashboard-link"),n("admin-link"),d("login-link")}}function B(){document.getElementById("login-form")&&N(),document.getElementById("register-form")&&O()}var k={};E(k,{init:()=>C,initCheckout:()=>R});function R(n){let{stripeKey:d,paypalClientId:r,courseId:s,currency:e}=n;if(typeof window.Stripe>"u"){let t=setInterval(()=>{typeof window.Stripe<"u"&&(clearInterval(t),q(n))},100);setTimeout(()=>clearInterval(t),1e4);return}q(n)}function q(n){let{stripeKey:d,paypalClientId:r,courseId:s,currency:e}=n,t=window.Stripe(d),u=t.elements().create("card",{style:{base:{fontSize:"16px",color:"#1e293b","::placeholder":{color:"#94a3b8"}}}});document.getElementById("card-element")&&u.mount("#card-element"),u.on("change",a=>{let c=document.getElementById("card-errors");c&&(c.textContent=a.error?a.error.message:"")}),window.selectPaymentMethod=function(a){let c=document.getElementById("select-stripe"),i=document.getElementById("select-paypal"),o=document.getElementById("stripe-payment"),l=document.getElementById("paypal-payment");a==="stripe"?(c?.classList.add("active"),c&&(c.style.borderColor="#8b5cf6"),i?.classList.remove("active"),i&&(i.style.borderColor="#e2e8f0"),o&&(o.style.display="block"),l&&(l.style.display="none")):(i?.classList.add("active"),i&&(i.style.borderColor="#8b5cf6"),c?.classList.remove("active"),c&&(c.style.borderColor="#e2e8f0"),l&&(l.style.display="block"),o&&(o.style.display="none"),F(r,e,s))};let p=document.getElementById("select-stripe");p&&p.addEventListener("click",()=>window.selectPaymentMethod("stripe"));let w=document.getElementById("select-paypal");w&&w.addEventListener("click",()=>window.selectPaymentMethod("paypal"));let f=document.getElementById("payment-form");f&&f.addEventListener("submit",async a=>{a.preventDefault();let c=document.getElementById("submit-stripe"),i=document.getElementById("checkout-message"),o=document.getElementById("card-holder-name");if(!c||!o){console.error("Missing required elements for payment processing");return}let l=c.innerHTML;c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin"></i> Procesando...',i&&(i.style.display="none");try{let g=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:s,paymentMethod:"stripe"})}),{clientSecret:h,error:b}=await g.json();if(b)throw new Error(b);let v=await t.confirmCardPayment(h,{payment_method:{card:u,billing_details:{name:o.value}}});if(v.error)throw new Error(v.error.message);if((await(await fetch("/api/verify-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentIntentId:v.paymentIntent.id,courseId:s})})).json()).success)window.location.href=`/pago-exitoso?courseId=${s}`;else throw new Error("Error al verificar el pago")}catch(g){i&&(i.className="auth-message error",i.textContent=g.message,i.style.display="block"),c.disabled=!1,c.innerHTML=l}})}function F(n,d,r){if(window.paypalLoaded)return;let s=document.createElement("script");s.src=`https://www.paypal.com/sdk/js?client-id=${n}&currency=${d}`,s.onload=()=>{window.paypalLoaded=!0,!(typeof window.paypal>"u")&&window.paypal.Buttons({createOrder:async()=>{try{let e=await fetch("/api/create-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({courseId:r})});if(!e.ok)throw new Error("Network response was not ok");let t=await e.json();if(!t.orderId)throw new Error("No order ID received");return t.orderId}catch(e){throw console.error("Error creating PayPal order:",e),e}},onApprove:async e=>{try{let t=await fetch("/api/capture-paypal-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderId:e.orderID,courseId:r})});if(!t.ok)throw new Error("Network response was not ok");let m=await t.json();if(m.success)window.location.href=`/pago-exitoso?courseId=${r}`;else throw new Error(m.error||"Payment capture failed")}catch(t){console.error("Error capturing PayPal order:",t);let m=document.getElementById("checkout-message");m&&(m.className="auth-message error",m.textContent=t.message||"Error al procesar el pago con PayPal",m.style.display="block")}},onError:e=>{console.error(e);let t=document.getElementById("checkout-message");t&&(t.className="auth-message error",t.textContent="Error al procesar el pago con PayPal",t.style.display="block")}}).render("#paypal-button-container")},document.head.appendChild(s)}function C(){let n=document.getElementById("checkout-config");if(n){let d={stripeKey:n.dataset.stripeKey,paypalClientId:n.dataset.paypalClientId,courseId:parseInt(n.dataset.courseId),currency:n.dataset.currency,price:parseFloat(n.dataset.price)};R(d)}}var D={};E(D,{init:()=>S,initQuiz:()=>z});function z(n,d,r,s){let e=r*60,t,m=Date.now(),u=document.getElementById("quizForm");if(!u)return;let y=()=>{e--;let p=Math.floor(e/60),w=e%60,f=p+":"+w.toString().padStart(2,"0"),a=document.getElementById("timerDisplay");a&&(a.textContent=f,a.classList.remove("warning","danger"),e<=60?a.classList.add("danger"):e<=180&&a.classList.add("warning")),e<=0&&(t&&clearInterval(t),alert("\xA1Tiempo agotado! La evaluaci\xF3n se enviar\xE1 autom\xE1ticamente."),u.dispatchEvent(new Event("submit")))};r>0&&(t&&clearInterval(t),t=setInterval(y,1e3)),u.addEventListener("submit",async p=>{if(p.preventDefault(),t&&clearInterval(t),e>0&&!confirm("\xBFEst\xE1s seguro de enviar la evaluaci\xF3n? No podr\xE1s cambiar tus respuestas.")){r>0&&(t&&clearInterval(t),t=setInterval(y,1e3));return}let w=new FormData(u),f={};for(let[o,l]of w.entries())if(o.startsWith("question_")){let g=o.replace("question_","");f[g]||(f[g]=[]),f[g].push(parseInt(l))}let a=Math.floor((Date.now()-m)/1e3),c=u.querySelector('button[type="submit"]'),i=c.innerHTML;try{c.disabled=!0,c.innerHTML='<i class="fas fa-spinner fa-spin"></i> Enviando...';let l=await(await fetch("/api/quiz/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({quizId:n,courseId:d,answers:f,timeTaken:a})})).json();l.success?window.location.href=`/cursos/${s}/quiz/${n}/resultado/${l.attemptId}`:(alert("Error: "+(l.error||"No se pudo enviar la evaluaci\xF3n")),c.disabled=!1,c.innerHTML=i)}catch(o){console.error("Error:",o),alert("Error al enviar la evaluaci\xF3n. Por favor, intenta de nuevo."),c.disabled=!1,c.innerHTML=i}}),window.addEventListener("beforeunload",p=>{u.querySelector('button[type="submit"]').disabled||(p.preventDefault(),p.returnValue="")})}function S(){let n=document.getElementById("quiz-config");if(n){let d=parseInt(n.dataset.quizId),r=parseInt(n.dataset.courseId),s=parseInt(n.dataset.timeLimit),e=n.dataset.slug;z(d,r,s,e)}}var P={};E(P,{init:()=>M,initCompletion:()=>Y,initNotes:()=>V,initVideoTracking:()=>A});function A(n,d,r,s){let e=0,t=s||0,m=!1,u,y=async(a,c)=>{try{await fetch(`/api/lessons/${n}/progress`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({position:Math.round(a),duration:Math.round(c),courseId:d})})}catch(i){console.error("Error saving video progress:",i)}};function p(){let a=i=>{try{let o=new URL(i,window.location.origin),l=o.protocol;if(l!=="https:"&&l!=="http:")return!1;let g=o.hostname.toLowerCase();return["youtube.com","www.youtube.com","m.youtube.com","youtu.be"].includes(g)||g.endsWith(".youtube.com")}catch{return!1}},c=document.querySelector("iframe");if(!(!c||!a(c.src))){if(!window.YT){let i=document.createElement("script");i.src="https://www.youtube.com/iframe_api";let o=document.getElementsByTagName("script")[0];o&&o.parentNode&&o.parentNode.insertBefore(i,o)}window.onYouTubeIframeAPIReady=function(){new window.YT.Player(c,{events:{onReady:function(i){m=!0,t=i.target.getDuration(),r>0&&r<t-5&&(i.target.seekTo(r,!0),console.log("Restored video position:",r)),u=setInterval(()=>{try{let o=i.target.getCurrentTime(),l=i.target.getDuration();o>0&&l>0&&(e=o,t=l,y(o,l))}catch(o){console.error("Error tracking YouTube progress:",o)}},1e4)},onStateChange:function(i){if(i.data===window.YT.PlayerState.PAUSED||i.data===window.YT.PlayerState.ENDED){let o=i.target.getCurrentTime(),l=i.target.getDuration();y(o,l)}i.data===window.YT.PlayerState.ENDED&&document.dispatchEvent(new CustomEvent("video-ended"))}}})},window.YT&&window.YT.Player&&window.onYouTubeIframeAPIReady()}}function w(){let a=o=>{try{let l=new URL(o,window.location.origin),g=l.protocol;if(g!=="https:"&&g!=="http:")return!1;let h=l.hostname.toLowerCase();return["vimeo.com","www.vimeo.com","player.vimeo.com"].includes(h)||h.endsWith(".vimeo.com")}catch{return!1}},c=document.querySelector("iframe");if(!c||!a(c.src))return;if(window.Vimeo)i();else{let o=document.createElement("script");o.src="https://player.vimeo.com/api/player.js",o.onload=i,document.head.appendChild(o)}function i(){let o=new window.Vimeo.Player(c);o.ready().then(()=>{m=!0,o.getDuration().then(l=>{t=l,r>0&&r<l-5&&o.setCurrentTime(r)}),o.on("timeupdate",l=>{e=l.seconds,t=l.duration}),u=setInterval(()=>{e>0&&t>0&&y(e,t)},1e4),o.on("ended",()=>{y(e,t),document.dispatchEvent(new CustomEvent("video-ended"))})})}}function f(){let a=document.querySelector("video");a&&(a.addEventListener("loadedmetadata",()=>{m=!0,t=a.duration,r>0&&r<a.duration-5&&(a.currentTime=r)}),a.addEventListener("timeupdate",()=>{e=a.currentTime,t=a.duration}),u=setInterval(()=>{a.currentTime>0&&a.duration>0&&y(a.currentTime,a.duration)},1e4),a.addEventListener("ended",()=>{y(a.currentTime,a.duration),document.dispatchEvent(new CustomEvent("video-ended"))}))}setTimeout(()=>{p(),w(),f()},1e3),window.addEventListener("beforeunload",()=>{if(e>0&&t>0){let a=JSON.stringify({position:Math.round(e),duration:Math.round(t),courseId:d}),c=new Blob([a],{type:"application/json"});navigator.sendBeacon(`/api/lessons/${n}/progress`,c)}}),window.addEventListener("unload",()=>{u&&clearInterval(u)})}function Y(n,d,r){let s=r,e=document.getElementById("completeBtn");if(!e)return;let t=async()=>{try{e.setAttribute("disabled","true");let u=await(await fetch(`/api/lessons/${n}/complete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:!s,courseId:d})})).json();if(u.success){if(s=!s,e.innerHTML=s?'<i class="fas fa-check-circle"></i> Completada':'<i class="far fa-circle"></i> Marcar Completa',e.style.background=s?"#10b981":"#64748b",u.certificateGenerated&&u.certificateId&&confirm("\xA1Felicitaciones! Has completado el curso al 100%. Tu certificado ha sido generado. \xBFDeseas verlo ahora?")){window.location.href="/certificado/"+u.certificateId;return}setTimeout(()=>window.location.reload(),500)}else alert("Error al actualizar el progreso")}catch(m){console.error("Error:",m),alert("Error al actualizar el progreso")}finally{e.removeAttribute("disabled")}};e.addEventListener("click",t),document.addEventListener("video-ended",()=>{s||setTimeout(t,1e3)})}function V(n,d){let r=document.getElementById("notesArea"),s=async()=>{if(r)try{let m=r.value,u=document.getElementById("saveStatus");(await(await fetch(`/api/lessons/${n}/notes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({notes:m,courseId:d})})).json()).success?u&&(u.style.display="inline",setTimeout(()=>u.style.display="none",3e3)):alert("Error al guardar notas")}catch(m){console.error("Error:",m),alert("Error al guardar notas")}},e;r&&r.addEventListener("input",()=>{clearTimeout(e),e=setTimeout(s,3e4)});let t=document.getElementById("saveNotesBtn");t&&t.addEventListener("click",s)}function M(){let n=document.getElementById("video-config");if(n){let d=parseInt(n.dataset.lessonId),r=parseInt(n.dataset.courseId),s=parseInt(n.dataset.lastPosition),e=parseInt(n.dataset.duration),t=n.dataset.isCompleted==="true";A(d,r,s,e),Y(d,r,t),V(d,r)}}var H={};E(H,{initCertificate:()=>x});function x(){let n=document.getElementById("downloadPdfBtn");n&&n.addEventListener("click",()=>{alert('Usa el bot\xF3n de imprimir y selecciona "Guardar como PDF" en tu navegador.'),window.print()})}window.ADM={auth:L,stripe:k,quiz:D,video:P,certificate:H};document.addEventListener("DOMContentLoaded",()=>{T(),I(),B(),C(),S(),x(),M()});})();
//# sourceMappingURL=client.js.map
